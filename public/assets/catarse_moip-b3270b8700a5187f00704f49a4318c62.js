App.addChild("MoipForm",_.extend({el:"form.moip",events:{"blur input:not(#payment_card_cpf):not(#user_document_payment_slip)":"checkInput"},getMoipToken:function(t){var e=this;$("#MoipWidget").length>0?_.isFunction(t)&&t():$.post("/payment/moip/"+this.contributionId+"/get_moip_token").success(function(a){e.paymentChoice.$("input").attr("disabled","disabled"),"fail"==a.get_token_response.status?e.checkoutFailure({Code:0,Mensagem:a.get_token_response.message}):(e.createMoipWidget(a),_.isFunction(t)&&t(a))})},createMoipWidget:function(t){widget_tag=$("<div/>").attr({id:t.widget_tag.tag_id,"data-token":t.widget_tag.token,"callback-method-success":t.widget_tag.callback_success,"callback-method-error":t.widget_tag.callback_error}),$("#catarse_moip_form").prepend(widget_tag)},checkoutFailure:function(t){this.loader.hide();var e=t.length>0?t[0]:t;914==e.Codigo&&(e.Mensagem+='. Tente <a href="javascript:window.location.reload();">recarregar a p\xe1gina</a> e repetir a opera\xe7\xe3o de pagamento.'),this.message.find(".message-text").html(e.Mensagem),this.message.slideDown("slow")},checkoutSuccessful:function(t){var e=this;$.post("/payment/moip/"+this.contributionId+"/moip_response",{response:t}).success(function(){if(e.loader.hide(),"Cancelado"==t.Status)return e.checkoutFailure({Codigo:0,Mensagem:t.Classificacao.Descricao+". Verifique os dados de pagamento e tente novamente."});if(t.url&&"block"!=$("#payment_type_cards_section").css("display")){var a=$('<a class="alt-link" target="__blank">Clique aqui para ver o boleto e completar o pagamento.</a>');a.attr("href",t.url),$(".link_content").empty().html(a),$("#payment-slip-link").slideDown("slow")}else{var o=$("#project_review").data("thank-you-path");location.href=o?o:"/"}})},activate:function(){this.message=this.$(".payment-error-message"),this.contributionId=$("input#contribution_id").val(),this.projectId=$("input#contribution_project_id").val(),this.loader=this.$(".loader img"),window.checkoutSuccessful=_.bind(this.checkoutSuccessful,this),window.checkoutFailure=_.bind(this.checkoutFailure,this),this.setupForm()}},Skull.Form)),App.views.MoipForm.UserDocument={onContentClick:function(){window.setTimeout(function(){app.moipForm.checkoutSuccessful({StatusPagamento:"Success"})},2e3)},onUserDocumentKeyup:function(t){var e=$(t.currentTarget),a=e.val();e.prop("maxlength",18);var o=this.validateCpf(a),n=this.validateCnpj(a.replace(/[\/.\-\_ ]/g,"")),i=a.replace(/[.\-\_ ]/g,"").length;i>10?("payment_card_cpf"!=e.attr("id")&&(11==i?e.mask("999.999.999-99?999"):14==i&&e.mask("99.999.999/9999-99"),(14!=i||11!=i)&&e.unmask()),o||n?($("[data-error-for="+e.prop("id")+"]").hide(),e.addClass("ok").removeClass("error"),$.ajax({url:"/projects/"+this.moipForm.projectId+"/contributions/"+this.moipForm.contributionId,type:"PUT",data:{contribution:{payer_document:a}}})):e.trigger("invalid")):e.trigger("invalid")},validateCpf:function(t){var e,a,o=0;t=t.replace(/[.\-\_ ]/g,"");var n=Math.floor(parseFloat(t)/100),i=100*n;for(e=0;8>=e;e++)o+=n%10*(e+2),n=Math.floor(n/10);for(a=2>o%11?0:11-o%11,i+=10*a,o=0,n=Math.floor(i/10),e=0;9>=e;e++)o+=n%10*(e+2),n=Math.floor(n/10);return a=2>o%11?0:11-o%11,i+=a,parseFloat(t)===i},validateCnpj:function(t){var e,a,o,n,i,r,c,s;if(s=1,t.length<14&&t.length<15)return!1;for(n=0;n<t.length-1;n++)if(t.charAt(n)!=t.charAt(n+1)){s=0;break}if(s)return!1;for(c=t.length-2,e=t.substring(0,c),a=t.substring(c),o=0,r=c-7,n=c;n>=1;n--)o+=e.charAt(c-n)*r--,2>r&&(r=9);if(i=2>o%11?0:11-o%11,i!=a.charAt(0))return!1;for(c+=1,e=t.substring(0,c),o=0,r=c-7,n=c;n>=1;n--)o+=e.charAt(c-n)*r--,2>r&&(r=9);return i=2>o%11?0:11-o%11,i!=a.charAt(1)?!1:!0}},App.views.MoipForm.addChild("PaymentAccount",_.extend({el:"#payment_type_account_section",events:{"change select#account":"onChangeAccount","click input#build_account_link":"onBuildAccountClick","keyup #user_document_account":"onUserDocumentKeyup","click .link_content a":"onContentClick"},activate:function(){this.moipForm=this.parent,this.$("input#user_document_account").mask("999.999.999-99")},onChangeAccount:function(t){var e=$(t.currentTarget).val();this.$("input#build_account_link").attr("disabled",!(""!=e&&void 0!=e))},onBuildAccountClick:function(t){var e=this;t.preventDefault(),$(t.currentTarget).hide(),e.moipForm.loader.show(),e.moipForm.getMoipToken(function(){var t={Instituicao:$("select#account").val(),Forma:"DebitoBancario"};MoipWidget(t)})}},App.views.MoipForm.UserDocument)),App.views.MoipForm.addChild("PaymentCard",_.extend({el:"#payment_type_cards_section",events:{"keyup #payment_card_number":"onKeyupPaymentCardNumber","click #credit_card_submit":"onSubmit","blur #payment_card_cpf":"onUserDocumentKeyup"},activate:function(){this.moipForm=this.parent,this.$("#payment_card_number").payment("formatCardNumber"),window.app.maskAllElements()},onKeyupPaymentCardNumber:function(t){this.$("#payment_card_flag").html(this.getCardFlag($(t.currentTarget).val()))},onSubmit:function(t){var e=this;return t.preventDefault(),e.moipForm.validate()?(e.moipForm.loader.show(),void e.moipForm.getMoipToken(function(){var t={Forma:"CartaoCredito",Instituicao:e.$("input#payment_card_flag").val(),Parcelas:"1",Recebimento:"AVista",CartaoCredito:{Numero:e.$("input#payment_card_number").val(),Expiracao:e.$("input#payment_card_date").val(),CodigoSeguranca:e.$("input#payment_card_source").val(),Portador:{Nome:e.$("input#payment_card_name").val(),DataNascimento:e.$("input#payment_card_birth").val(),Telefone:e.$("input#payment_card_phone").val(),Identidade:e.$("input#payment_card_cpf").val()}}};MoipWidget(t)})):!1},getCardFlag:function(t){return $.payment.cardType(t).toUpperCase()}},App.views.MoipForm.UserDocument)),App.views.MoipForm.addChild("PaymentChoice",{el:".list_payment",events:{'change input[type="radio"]':"onListPaymentChange"},onListPaymentChange:function(t){$(".payment_section").fadeOut("fast",function(){var e=$(t.currentTarget).attr("id");$("#"+e+"_section").fadeIn("fast")})},activate:function(){this.$("input#payment_type_cards").click()}}),App.views.MoipForm.addChild("PaymentSlip",_.extend({el:"#payment_type_boleto_section",events:{"click input#build_boleto":"onBuildBoletoClick","click .link_content a":"onContentClick","blur #user_document_payment_slip":"onUserDocumentKeyup"},activate:function(){this.moipForm=this.parent},onBuildBoletoClick:function(t){var e=this;return t.preventDefault(),e.moipForm.validate()?($(t.currentTarget).hide(),this.$("#payment-slip-instructions").slideUp("slow"),e.moipForm.loader.show(),void e.moipForm.getMoipToken(function(){var t={Forma:"BoletoBancario"};MoipWidget(t)})):!1}},App.views.MoipForm.UserDocument)),$(function(){app.createViewGetters()});